<!DOCTYPE html>
<!-- Admin Console UI (single-page). Login persists admin key to localStorage under `admin_key`. -->
<html>

<head>
  <meta charset="utf-8" />
  <title>Admin Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f1720;
      --panel: #0b1220;
      --accent: #3b82f6;
      --muted: #94a3b8;
      --card: #071024;
    }

    body {
      font-family: Segoe UI, Arial, Helvetica, sans-serif;
      background: linear-gradient(180deg, #071024, #071433);
      color: #e6eef8;
      margin: 0;
    }

    .wrap {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 440px;
      background: var(--panel);
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .content {
      flex: 1;
      padding: 24px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .section {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
    }

    .btn {
      background: var(--accent);
      border: none;
      padding: 8px 14px;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .input,
    .textarea,
    .select {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px;
      border-radius: 6px;
      border: 1px solid #123;
      background: rgba(7, 16, 36, 0.6);
      color: #e6eef8;
    }

    .lists-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      min-height: 0;
    }

    .list-section {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .list-section h3 {
      margin: 0 0 12px;
    }

    .list {
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .item {
      padding: 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      line-height: 1.4;
    }

    .item small {
      color: var(--muted);
    }

    pre {
      white-space: pre-wrap;
      background: #021022;
      padding: 12px;
      border-radius: 6px;
      overflow: auto;
      font-size: 14px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    header .actions {
      display: flex;
      gap: 8px;
    }

    .inline-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .input-inline {
      width: 120px;
      margin: 0;
    }

    .select-inline {
      width: 140px;
      margin: 0;
    }

    @media (max-width: 1024px) {
      .wrap {
        flex-direction: column;
      }

      .sidebar {
        width: auto;
      }

      .lists-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <aside class="sidebar">
      <header>
        <h2>Admin</h2>
        <div class="actions">
          <button class="btn" id="loginBtn">Login</button>
          <button class="btn" id="logoutBtn">Logout</button>
          <button class="btn" id="reloadBtn">Reload</button>
        </div>
      </header>
      <div class="lists-grid">
        <section class="list-section">
          <h3>API Keys</h3>
          <div id="keysList" class="list"></div>
        </section>
        <section class="list-section">
          <h3>AI Models</h3>
          <div id="modelsList" class="list"></div>
        </section>
      </div>
    </aside>
    <main class="content">
      <section class="section">
        <h3>Create Key</h3>
        <input id="createName" class="input" placeholder="Key name (identifier)" />
        <input id="createProjects" class="input" placeholder="Projects (comma separated, leave blank for wildcard)" />
        <select id="createRole" class="select">
          <option value="user">User</option>
          <option value="service">Service</option>
          <option value="admin">Admin (full access)</option>
        </select>
        <textarea id="createNotes" class="textarea" rows="2" placeholder="Notes (optional)"></textarea>
        <button class="btn" id="createKeyBtn">Generate Key</button>
        <pre id="createOut"></pre>
      </section>

      <section class="section">
        <h3>Revoke Key</h3>
        <input id="revokeName" class="input" placeholder="Key name to revoke" />
        <button class="btn" id="revokeBtn">Revoke</button>
        <pre id="revokeOut"></pre>
      </section>

      <section class="section">
        <h3>Model Management</h3>
        <input id="modelName" class="input" placeholder="model name (e.g. deepseek-r1:14b)" />
        <div class="actions">
          <button class="btn" id="pullModel">Pull</button>
          <button class="btn" id="deleteModel">Delete</button>
          <button class="btn" id="switchModel">Switch</button>
        </div>
        <pre id="modelOut"></pre>
      </section>

      <section class="section">
        <h3>Maintenance</h3>
        <div class="actions">
          <button class="btn" id="gitPull">Git Pull</button>
        </div>
        <div class="actions">
          <div class="inline-input-group">
            <input id="reloadDelayValue" class="input input-inline" type="number" min="0" step="0.1" value="1" />
            <select id="reloadDelayUnit" class="select select-inline">
              <option value="seconds">Seconds</option>
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
            </select>
          </div>
          <button class="btn" id="reloadServer">Reload Server</button>
        </div>
        <pre id="maintenanceOut"></pre>
      </section>
    </main>
  </div>

  <script>
    let adminKey = localStorage.getItem("admin_key") || "";

    function setAdminKey(value) {
      adminKey = value || "";
      if (adminKey) {
        localStorage.setItem("admin_key", adminKey);
      } else {
        localStorage.removeItem("admin_key");
      }
    }

    async function callApi(path, opts = {}) {
      opts.headers = opts.headers || {};
      if (adminKey) opts.headers["X-API-Admin-Key"] = adminKey;
      const res = await fetch(path, opts);
      if (!res.ok) {
        const detail = await res.json().catch(() => ({}));
        throw new Error(detail.detail || detail.error || res.statusText);
      }
      return res.json().catch(() => ({ error: "invalid json" }));
    }

    function formatKeyEntry(name, info) {
      const projects = (info.projects || []).length
        ? info.projects.join(", ")
        : "*";
      const lines = [
        `<strong>${name}</strong>`,
        `<small>Role: ${info.role || "user"}</small>`,
        `<small>Projects: ${projects}</small>`,
      ];
      if (info.created_at) {
        const created = new Date(info.created_at).toLocaleString();
        lines.push(`<small>Created: ${created}</small>`);
      }
      const lastUsedRaw = info.last_used;
      if (lastUsedRaw) {
        const parsed = new Date(lastUsedRaw);
        const formatted = Number.isNaN(parsed.getTime())
          ? lastUsedRaw
          : parsed.toLocaleString();
        lines.push(`<small>Last used: ${formatted}</small>`);
      } else {
        lines.push(`<small>Last used: never</small>`);
      }
      if (info.notes) {
        lines.push(`<small>Notes: ${info.notes}</small>`);
      }
      if (info.hash_preview) {
        lines.push(`<small>Hash: ${info.hash_preview}</small>`);
      }
      return lines.join("<br>");
    }

    async function refreshAll() {
      if (!adminKey) {
        return;
      }
      try {
        const [keys, models] = await Promise.all([
          callApi("/admin/list-keys"),
          callApi("/admin/models/list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}),
          }),
        ]);

        const keysDiv = document.getElementById("keysList");
        keysDiv.innerHTML = "";
        for (const [name, info] of Object.entries(keys.keys || {})) {
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = formatKeyEntry(name, info);
          keysDiv.appendChild(el);
        }

        const modelsDiv = document.getElementById("modelsList");
        modelsDiv.innerHTML = "";
        for (const m of models.models?.models || models.models || []) {
          const data = typeof m === "string" ? { model: m } : m;
          const el = document.createElement("div");
          el.className = "item";
          el.textContent = data.model || JSON.stringify(data);
          modelsDiv.appendChild(el);
        }
      } catch (err) {
        console.error(err);
        alert(err.message || err);
      }
    }

    function clearUi() {
      document.getElementById("keysList").innerHTML = "";
      document.getElementById("modelsList").innerHTML = "";
      document.getElementById("createOut").textContent = "";
      document.getElementById("revokeOut").textContent = "";
      document.getElementById("modelOut").textContent = "";
      document.getElementById("maintenanceOut").textContent = "";
    }

    function updateAuthButtons() {
      const loggedIn = Boolean(adminKey);
      document.getElementById("logoutBtn").disabled = !loggedIn;
      document.getElementById("reloadBtn").disabled = !loggedIn;
      document.getElementById("createKeyBtn").disabled = !loggedIn;
      document.getElementById("revokeBtn").disabled = !loggedIn;
      document.getElementById("pullModel").disabled = !loggedIn;
      document.getElementById("deleteModel").disabled = !loggedIn;
      document.getElementById("switchModel").disabled = !loggedIn;
      document.getElementById("gitPull").disabled = !loggedIn;
      document.getElementById("reloadServer").disabled = !loggedIn;
      document.getElementById("reloadDelayValue").disabled = !loggedIn;
      document.getElementById("reloadDelayUnit").disabled = !loggedIn;
    }

    document.getElementById("loginBtn").onclick = async () => {
      const value = prompt("Enter admin key:", adminKey) || "";
      setAdminKey(value.trim());
      updateAuthButtons();
      if (!adminKey) {
        clearUi();
        return;
      }
      await refreshAll();
    };

    document.getElementById("logoutBtn").onclick = () => {
      setAdminKey("");
      updateAuthButtons();
      clearUi();
    };

    document.getElementById("reloadBtn").onclick = async () => {
      await refreshAll();
    };

    document.getElementById("createKeyBtn").onclick = async () => {
      const name = document.getElementById("createName").value.trim();
      if (!name) {
        alert("Key name is required");
        return;
      }
      const payload = {
        name,
        projects: document.getElementById("createProjects").value.trim(),
        role: document.getElementById("createRole").value,
        notes:
          document.getElementById("createNotes").value.trim() || undefined,
      };
      try {
        const res = await callApi("/admin/generate-key", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        document.getElementById("createOut").textContent = JSON.stringify(
          res,
          null,
          2
        );
        await refreshAll();
      } catch (err) {
        document.getElementById("createOut").textContent = String(err);
      }
    };

    document.getElementById("revokeBtn").onclick = async () => {
      const name = document.getElementById("revokeName").value.trim();
      if (!name) {
        alert("Key name required");
        return;
      }
      try {
        const res = await callApi("/admin/revoke-key", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name }),
        });
        document.getElementById("revokeOut").textContent = JSON.stringify(
          res,
          null,
          2
        );
        await refreshAll();
      } catch (err) {
        document.getElementById("revokeOut").textContent = String(err);
      }
    };

    async function handleModelAction(path) {
      const name = document.getElementById("modelName").value.trim();
      if (!name) {
        alert("Model name is required");
        return;
      }
      const payload = { model: name };
      try {
        const res = await callApi(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: Object.keys(payload).length
            ? JSON.stringify(payload)
            : undefined,
        });
        document.getElementById("modelOut").textContent = JSON.stringify(
          res,
          null,
          2
        );
        await refreshAll();
      } catch (err) {
        document.getElementById("modelOut").textContent = String(err);
      }
    }

    document.getElementById("pullModel").onclick = () =>
      handleModelAction("/admin/models/pull");
    document.getElementById("deleteModel").onclick = () =>
      handleModelAction("/admin/models/delete");
    document.getElementById("switchModel").onclick = () =>
      handleModelAction("/admin/models/switch");

    async function handleMaintenanceAction(path) {
      let payload;
      if (path === "/admin/server/reload") {
        const valueInput = document.getElementById("reloadDelayValue");
        const unitSelect = document.getElementById("reloadDelayUnit");
        const rawValue = Number(valueInput.value);
        if (!Number.isFinite(rawValue) || rawValue < 0) {
          alert("Delay must be a non-negative number");
          return;
        }
        const multipliers = {
          seconds: 1,
          minutes: 60,
          hours: 3600,
          days: 86400,
        };
        const unit = unitSelect.value;
        const multiplier = multipliers[unit] || 1;
        const delaySeconds = rawValue * multiplier;
        payload = { delay_seconds: delaySeconds };
      }
      try {
        const options = { method: "POST" };
        if (payload !== undefined) {
          options.headers = { "Content-Type": "application/json" };
          options.body = JSON.stringify(payload);
        }
        const res = await callApi(path, options);
        document.getElementById("maintenanceOut").textContent = JSON.stringify(
          res,
          null,
          2
        );
        if (path === "/admin/git-pull") {
          await refreshAll();
        }
      } catch (err) {
        document.getElementById("maintenanceOut").textContent = String(err);
      }
    }

    document.getElementById("gitPull").onclick = () =>
      handleMaintenanceAction("/admin/git-pull");
    document.getElementById("reloadServer").onclick = () =>
      handleMaintenanceAction("/admin/server/reload");

    if (adminKey) {
      updateAuthButtons();
      refreshAll();
    } else {
      updateAuthButtons();
    }
  </script>
</body>

</html>